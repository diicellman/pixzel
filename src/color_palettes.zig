const std = @import("std");
const zigimg = @import("zigimg");

pub const Palette = struct {
    name: []const u8,
    colors: []const zigimg.color.Rgba32,
};

pub const PaletteError = error{
    PaletteNotFound,
};

pub const presetPalettes = [_]Palette{
    .{
        .name = "retro",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 0, .g = 0, .b = 0, .a = 255 },
            .{ .r = 255, .g = 255, .b = 255, .a = 255 },
            .{ .r = 136, .g = 0, .b = 0, .a = 255 },
            .{ .r = 170, .g = 255, .b = 238, .a = 255 },
            .{ .r = 204, .g = 68, .b = 204, .a = 255 },
            .{ .r = 0, .g = 204, .b = 85, .a = 255 },
            .{ .r = 0, .g = 0, .b = 170, .a = 255 },
            .{ .r = 238, .g = 238, .b = 119, .a = 255 },
            .{ .r = 221, .g = 136, .b = 85, .a = 255 },
            .{ .r = 102, .g = 68, .b = 0, .a = 255 },
            .{ .r = 255, .g = 119, .b = 119, .a = 255 },
            .{ .r = 51, .g = 51, .b = 51, .a = 255 },
            .{ .r = 119, .g = 119, .b = 119, .a = 255 },
            .{ .r = 170, .g = 255, .b = 102, .a = 255 },
            .{ .r = 0, .g = 136, .b = 255, .a = 255 },
            .{ .r = 187, .g = 187, .b = 187, .a = 255 },
        },
    },
    .{
        .name = "grayscale",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 0, .g = 0, .b = 0, .a = 255 },
            .{ .r = 32, .g = 32, .b = 32, .a = 255 },
            .{ .r = 64, .g = 64, .b = 64, .a = 255 },
            .{ .r = 96, .g = 96, .b = 96, .a = 255 },
            .{ .r = 128, .g = 128, .b = 128, .a = 255 },
            .{ .r = 160, .g = 160, .b = 160, .a = 255 },
            .{ .r = 192, .g = 192, .b = 192, .a = 255 },
            .{ .r = 224, .g = 224, .b = 224, .a = 255 },
            .{ .r = 255, .g = 255, .b = 255, .a = 255 },
        },
    },
    .{
        .name = "muted",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 243, .g = 233, .b = 201, .a = 255 },
            .{ .r = 160, .g = 82, .b = 45, .a = 255 },
            .{ .r = 107, .g = 55, .b = 90, .a = 255 },
            .{ .r = 75, .g = 87, .b = 123, .a = 255 },
            .{ .r = 140, .g = 162, .b = 173, .a = 255 },
            .{ .r = 208, .g = 183, .b = 149, .a = 255 },
            .{ .r = 181, .g = 101, .b = 118, .a = 255 },
            .{ .r = 239, .g = 195, .b = 164, .a = 255 },
            .{ .r = 117, .g = 137, .b = 78, .a = 255 },
            .{ .r = 190, .g = 190, .b = 190, .a = 255 },
            .{ .r = 82, .g = 80, .b = 100, .a = 255 },
            .{ .r = 214, .g = 133, .b = 79, .a = 255 },
            .{ .r = 178, .g = 181, .b = 128, .a = 255 },
            .{ .r = 147, .g = 112, .b = 152, .a = 255 },
            .{ .r = 55, .g = 48, .b = 61, .a = 255 },
            .{ .r = 240, .g = 240, .b = 240, .a = 255 },
        },
    },
    .{
        .name = "onedark",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 40, .g = 44, .b = 52, .a = 255 },
            .{ .r = 171, .g = 178, .b = 191, .a = 255 },
            .{ .r = 224, .g = 108, .b = 117, .a = 255 },
            .{ .r = 152, .g = 195, .b = 121, .a = 255 },
            .{ .r = 229, .g = 192, .b = 123, .a = 255 },
            .{ .r = 97, .g = 175, .b = 239, .a = 255 },
            .{ .r = 198, .g = 120, .b = 221, .a = 255 },
            .{ .r = 86, .g = 182, .b = 194, .a = 255 },
            .{ .r = 190, .g = 80, .b = 70, .a = 255 },
            .{ .r = 92, .g = 99, .b = 112, .a = 255 },
            .{ .r = 130, .g = 137, .b = 151, .a = 255 },
            .{ .r = 209, .g = 154, .b = 102, .a = 255 },
            .{ .r = 195, .g = 232, .b = 141, .a = 255 },
            .{ .r = 56, .g = 62, .b = 71, .a = 255 },
            .{ .r = 239, .g = 241, .b = 245, .a = 255 },
            .{ .r = 75, .g = 82, .b = 94, .a = 255 },
        },
    },
    .{
        .name = "tokyonight",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 26, .g = 27, .b = 38, .a = 255 },
            .{ .r = 192, .g = 202, .b = 245, .a = 255 },
            .{ .r = 247, .g = 118, .b = 142, .a = 255 },
            .{ .r = 158, .g = 206, .b = 106, .a = 255 },
            .{ .r = 224, .g = 175, .b = 104, .a = 255 },
            .{ .r = 122, .g = 162, .b = 247, .a = 255 },
            .{ .r = 187, .g = 154, .b = 247, .a = 255 },
            .{ .r = 125, .g = 207, .b = 255, .a = 255 },
            .{ .r = 255, .g = 158, .b = 100, .a = 255 },
            .{ .r = 65, .g = 72, .b = 104, .a = 255 },
            .{ .r = 145, .g = 153, .b = 179, .a = 255 },
            .{ .r = 255, .g = 111, .b = 112, .a = 255 },
            .{ .r = 115, .g = 218, .b = 202, .a = 255 },
            .{ .r = 42, .g = 45, .b = 64, .a = 255 },
            .{ .r = 222, .g = 224, .b = 255, .a = 255 },
            .{ .r = 86, .g = 95, .b = 137, .a = 255 },
        },
    },
    .{
        .name = "gruvbox",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 40, .g = 40, .b = 40, .a = 255 },
            .{ .r = 235, .g = 219, .b = 178, .a = 255 },
            .{ .r = 204, .g = 36, .b = 29, .a = 255 },
            .{ .r = 152, .g = 151, .b = 26, .a = 255 },
            .{ .r = 215, .g = 153, .b = 33, .a = 255 },
            .{ .r = 69, .g = 133, .b = 136, .a = 255 },
            .{ .r = 177, .g = 98, .b = 134, .a = 255 },
            .{ .r = 104, .g = 157, .b = 106, .a = 255 },
            .{ .r = 214, .g = 93, .b = 14, .a = 255 },
            .{ .r = 124, .g = 111, .b = 100, .a = 255 },
            .{ .r = 168, .g = 153, .b = 132, .a = 255 },
            .{ .r = 251, .g = 73, .b = 52, .a = 255 },
            .{ .r = 184, .g = 187, .b = 38, .a = 255 },
            .{ .r = 250, .g = 189, .b = 47, .a = 255 },
            .{ .r = 131, .g = 165, .b = 152, .a = 255 },
            .{ .r = 211, .g = 134, .b = 155, .a = 255 },
            .{ .r = 142, .g = 192, .b = 124, .a = 255 },
            .{ .r = 254, .g = 128, .b = 25, .a = 255 },
            .{ .r = 60, .g = 56, .b = 54, .a = 255 },
            .{ .r = 251, .g = 241, .b = 199, .a = 255 },
        },
    },
    .{
        .name = "nord",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 46, .g = 52, .b = 64, .a = 255 },
            .{ .r = 216, .g = 222, .b = 233, .a = 255 },
            .{ .r = 191, .g = 97, .b = 106, .a = 255 },
            .{ .r = 163, .g = 190, .b = 140, .a = 255 },
            .{ .r = 235, .g = 203, .b = 139, .a = 255 },
            .{ .r = 129, .g = 161, .b = 193, .a = 255 },
            .{ .r = 180, .g = 142, .b = 173, .a = 255 },
            .{ .r = 136, .g = 192, .b = 208, .a = 255 },
            .{ .r = 208, .g = 135, .b = 112, .a = 255 },
            .{ .r = 76, .g = 86, .b = 106, .a = 255 },
            .{ .r = 143, .g = 188, .b = 187, .a = 255 },
            .{ .r = 191, .g = 97, .b = 106, .a = 255 },
            .{ .r = 94, .g = 129, .b = 172, .a = 255 },
            .{ .r = 59, .g = 66, .b = 82, .a = 255 },
            .{ .r = 229, .g = 233, .b = 240, .a = 255 },
            .{ .r = 67, .g = 76, .b = 94, .a = 255 },
        },
    },
    .{
        .name = "catppuccin",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 30, .g = 30, .b = 46, .a = 255 },
            .{ .r = 205, .g = 214, .b = 244, .a = 255 },
            .{ .r = 243, .g = 139, .b = 168, .a = 255 },
            .{ .r = 166, .g = 227, .b = 161, .a = 255 },
            .{ .r = 249, .g = 226, .b = 175, .a = 255 },
            .{ .r = 137, .g = 180, .b = 250, .a = 255 },
            .{ .r = 203, .g = 166, .b = 247, .a = 255 },
            .{ .r = 137, .g = 220, .b = 235, .a = 255 },
            .{ .r = 250, .g = 179, .b = 135, .a = 255 },
            .{ .r = 88, .g = 91, .b = 112, .a = 255 },
            .{ .r = 186, .g = 194, .b = 222, .a = 255 },
            .{ .r = 235, .g = 160, .b = 172, .a = 255 },
            .{ .r = 148, .g = 226, .b = 213, .a = 255 },
            .{ .r = 49, .g = 50, .b = 68, .a = 255 },
            .{ .r = 245, .g = 224, .b = 220, .a = 255 },
            .{ .r = 110, .g = 115, .b = 141, .a = 255 },
        },
    },
    .{
        .name = "dracula",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 40, .g = 42, .b = 54, .a = 255 },
            .{ .r = 248, .g = 248, .b = 242, .a = 255 },
            .{ .r = 255, .g = 85, .b = 85, .a = 255 },
            .{ .r = 80, .g = 250, .b = 123, .a = 255 },
            .{ .r = 241, .g = 250, .b = 140, .a = 255 },
            .{ .r = 189, .g = 147, .b = 249, .a = 255 },
            .{ .r = 255, .g = 121, .b = 198, .a = 255 },
            .{ .r = 139, .g = 233, .b = 253, .a = 255 },
            .{ .r = 255, .g = 184, .b = 108, .a = 255 },
            .{ .r = 68, .g = 71, .b = 90, .a = 255 },
            .{ .r = 98, .g = 114, .b = 164, .a = 255 },
            .{ .r = 255, .g = 110, .b = 110, .a = 255 },
            .{ .r = 95, .g = 255, .b = 135, .a = 255 },
            .{ .r = 58, .g = 60, .b = 78, .a = 255 },
            .{ .r = 241, .g = 250, .b = 140, .a = 255 },
            .{ .r = 68, .g = 71, .b = 90, .a = 255 },
        },
    },
    .{
        .name = "solarized",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 0, .g = 43, .b = 54, .a = 255 },
            .{ .r = 131, .g = 148, .b = 150, .a = 255 },
            .{ .r = 220, .g = 50, .b = 47, .a = 255 },
            .{ .r = 133, .g = 153, .b = 0, .a = 255 },
            .{ .r = 181, .g = 137, .b = 0, .a = 255 },
            .{ .r = 38, .g = 139, .b = 210, .a = 255 },
            .{ .r = 211, .g = 54, .b = 130, .a = 255 },
            .{ .r = 42, .g = 161, .b = 152, .a = 255 },
            .{ .r = 203, .g = 75, .b = 22, .a = 255 },
            .{ .r = 7, .g = 54, .b = 66, .a = 255 },
            .{ .r = 88, .g = 110, .b = 117, .a = 255 },
            .{ .r = 253, .g = 246, .b = 227, .a = 255 },
            .{ .r = 238, .g = 232, .b = 213, .a = 255 },
            .{ .r = 0, .g = 43, .b = 54, .a = 255 },
            .{ .r = 253, .g = 246, .b = 227, .a = 255 },
            .{ .r = 101, .g = 123, .b = 131, .a = 255 },
        },
    },
    .{
        .name = "github_dark",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 13, .g = 17, .b = 23, .a = 255 },
            .{ .r = 201, .g = 209, .b = 217, .a = 255 },
            .{ .r = 248, .g = 81, .b = 73, .a = 255 },
            .{ .r = 63, .g = 185, .b = 80, .a = 255 },
            .{ .r = 231, .g = 197, .b = 71, .a = 255 },
            .{ .r = 58, .g = 175, .b = 255, .a = 255 },
            .{ .r = 187, .g = 128, .b = 255, .a = 255 },
            .{ .r = 84, .g = 174, .b = 255, .a = 255 },
            .{ .r = 209, .g = 154, .b = 102, .a = 255 },
            .{ .r = 33, .g = 38, .b = 45, .a = 255 },
            .{ .r = 139, .g = 148, .b = 158, .a = 255 },
            .{ .r = 255, .g = 123, .b = 114, .a = 255 },
            .{ .r = 87, .g = 217, .b = 163, .a = 255 },
            .{ .r = 22, .g = 27, .b = 34, .a = 255 },
            .{ .r = 225, .g = 228, .b = 232, .a = 255 },
            .{ .r = 106, .g = 115, .b = 125, .a = 255 },
        },
    },
    .{
        .name = "monochrome",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 0, .g = 0, .b = 0, .a = 255 },
            .{ .r = 255, .g = 255, .b = 255, .a = 255 },
            .{ .r = 85, .g = 85, .b = 85, .a = 255 },
            .{ .r = 170, .g = 170, .b = 170, .a = 255 },
            .{ .r = 212, .g = 212, .b = 212, .a = 255 },
            .{ .r = 128, .g = 128, .b = 128, .a = 255 },
            .{ .r = 192, .g = 192, .b = 192, .a = 255 },
            .{ .r = 224, .g = 224, .b = 224, .a = 255 },
            .{ .r = 160, .g = 160, .b = 160, .a = 255 },
            .{ .r = 32, .g = 32, .b = 32, .a = 255 },
            .{ .r = 96, .g = 96, .b = 96, .a = 255 },
            .{ .r = 144, .g = 144, .b = 144, .a = 255 },
            .{ .r = 208, .g = 208, .b = 208, .a = 255 },
            .{ .r = 16, .g = 16, .b = 16, .a = 255 },
            .{ .r = 240, .g = 240, .b = 240, .a = 255 },
            .{ .r = 64, .g = 64, .b = 64, .a = 255 },
        },
    },
    .{
        .name = "monokai",
        .colors = &[_]zigimg.color.Rgba32{
            .{ .r = 39, .g = 40, .b = 34, .a = 255 },
            .{ .r = 248, .g = 248, .b = 242, .a = 255 },
            .{ .r = 249, .g = 38, .b = 114, .a = 255 },
            .{ .r = 166, .g = 226, .b = 46, .a = 255 },
            .{ .r = 230, .g = 219, .b = 116, .a = 255 },
            .{ .r = 102, .g = 217, .b = 239, .a = 255 },
            .{ .r = 174, .g = 129, .b = 255, .a = 255 },
            .{ .r = 161, .g = 239, .b = 228, .a = 255 },
            .{ .r = 253, .g = 151, .b = 31, .a = 255 },
            .{ .r = 69, .g = 70, .b = 64, .a = 255 },
            .{ .r = 117, .g = 113, .b = 94, .a = 255 },
            .{ .r = 249, .g = 38, .b = 114, .a = 255 },
            .{ .r = 166, .g = 226, .b = 46, .a = 255 },
            .{ .r = 56, .g = 56, .b = 48, .a = 255 },
            .{ .r = 248, .g = 248, .b = 242, .a = 255 },
            .{ .r = 117, .g = 113, .b = 94, .a = 255 },
        },
    },
};

pub fn getPaletteByName(name: []const u8) !Palette {
    for (presetPalettes) |palette| {
        if (std.mem.eql(u8, palette.name, name)) {
            return palette;
        }
    }
    return PaletteError.PaletteNotFound;
}

pub fn loadCustomPalette(allocator: std.mem.Allocator, file_path: []const u8) !Palette {
    const file = try std.fs.cwd().openFile(file_path, .{});
    defer file.close();

    const file_size = try file.getEndPos();
    const buffer = try allocator.alloc(u8, file_size);
    defer allocator.free(buffer);

    const bytes_read = try file.readAll(buffer);
    if (bytes_read != file_size) return error.IncompleteRead;

    var color_count: usize = 0;
    var lines = std.mem.split(u8, buffer, "\n");
    while (lines.next()) |line| {
        const trimmed = std.mem.trim(u8, line, &std.ascii.whitespace);
        if (trimmed.len > 0) color_count += 1;
    }

    const colors = try allocator.alloc(zigimg.color.Rgba32, color_count);
    errdefer allocator.free(colors);

    var index: usize = 0;
    lines = std.mem.split(u8, buffer, "\n");
    while (lines.next()) |line| {
        const trimmed = std.mem.trim(u8, line, &std.ascii.whitespace);
        if (trimmed.len == 0) continue;

        var color_parts = std.mem.split(u8, trimmed, ",");
        const r = try std.fmt.parseInt(u8, color_parts.next() orelse return error.InvalidFormat, 10);
        const g = try std.fmt.parseInt(u8, color_parts.next() orelse return error.InvalidFormat, 10);
        const b = try std.fmt.parseInt(u8, color_parts.next() orelse return error.InvalidFormat, 10);

        colors[index] = .{ .r = r, .g = g, .b = b, .a = 255 };
        index += 1;
    }

    return Palette{
        .name = try allocator.dupe(u8, "custom"),
        .colors = colors,
    };
}
